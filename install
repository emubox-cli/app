#!/bin/bash

set -euo >> /dev/null

debug=0
already_present=0
do_complete_setup=1
assemble_file="https://emubox.pupper.space/emubox.ini"
emubox_url="https://emubox.pupper.space/emubox"
emubox_bin="$HOME/.local/bin/emubox"
while getopts ":d" arg; do
    case $arg in
        d) debug=1
    esac
done

if [ "$EUID" == 0 ]; then 
    echo "Please don't run this as root."
    exit
fi

if ! type distrobox &> /dev/null; then
    echo "Distrobox not found on system. Exitting..."
    exit
fi

mkdir -p $HOME/.emubox/{apps,icons}
mkdir -p $HOME/.emubox/.local/share
mkdir -p $HOME/.emubox/icons
mkdir -p $HOME/.local/share/applications
mkdir -p $HOME/.local/bin

#if [ -f $HOME/.local/share/Steam ]; then
#    ln -s $HOME/.local/share/Steam $HOME/.emubox/.local/share/Steam
#fi

if [ $debug == 0 ]; then
    if [ -f $emubox_bin ]; then
        echo "Checking for updates..."
        current_ver=$($emubox_bin -v)

        curl -sSL -o /tmp/emubox $emubox_url
        chmod +x /tmp/emubox
        latest_ver=$(/tmp/emubox -v)

        if [ $latest_ver == $current_ver ]; then
            echo "Emubox to Date!"
            rm /tmp/emubox
        else
            echo "Updating emubox package manager..."
            rm $emubox_bin
            mv /tmp/emubox $emubox_bin           
        fi

        echo "Updating emubox apps..."
        $emubox_bin update

        do_complete_setup=0
    else
        echo "Downloading emubox package manager..."
        curl -o $emubox_bin $emubox_url
        
        chmod +x $emubox_bin

        do_complete_setup=0
    fi
    
else
    echo "Building emubox..."
    just build
    cp ./dist/emubox $emubox_bin
    assemble_file="emubox.ini"
fi

if [ -z "$(distrobox ls | grep emubox)" ]; then
    echo "Creating container..."
    distrobox assemble create --file $assemble_file
fi

if [ $do_complete_setup == 1 ]; then 

    echo "Initializing emubox..."
    if [ -f $HOME/.emubox/config.json ]; then
        $emubox_bin init --restore
    else
        $emubox_bin init
    fi
fi

